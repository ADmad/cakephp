tools:
  external_code_coverage:
    timeout: 1800
    runs: 3

build:
  environment:
    php:
      version: 7.2

  nodes:
    phpcs:
      tests:
        override:
          - phpcs-run src/ tests/

    static-analysis:
      environment:
        php:
          ini:
            'memory_limit': -1
      dependencies:
        override:
          - pecl install apcu
          - pecl install redis
          - pecl install memcached
          - composer stan-setup
      tests:
        override:
          - command: vendor/bin/psalm.phar --show-info=false --report-show-info=false --report=psalm-checkstyle.xml
            analysis:
              file: psalm-checkstyle.xml
              format: 'general-checkstyle'

          - command: vendor/bin/phpstan.phar analyse --error-format checkstyle src/ | sed '/^$/d' > phpstan-checkstyle.xml
            analysis:
              file: phpstan-checkstyle.xml
              format: 'general-checkstyle'

build_failure_conditions:
  # Issues reported by any analyzer (which generates report in checkstyle format) like phpcs
  - 'issues.count > 0'
  # Code Coverage decreased from previous inspection
  - 'project.metric_change("scrutinizer.test_coverage", < -0.01)'
  # Code Coverage drops below 90%
  - 'project.metric("scrutinizer.test_coverage", < 0.90)'
